<!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">-- **showr(t:tbl) :str**     </font></i>
<i><font color="#9A1900">-- Return table as string.</font></i>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">show</font></b><font color="#990000">(</font>t<font color="#990000">,</font>     u<font color="#990000">,</font>mt<font color="#990000">,</font>pre<font color="#990000">)</font>
  <b><font color="#0000FF">if</font></b>   #t<font color="#990000">&gt;</font><font color="#993399">0</font>
  <b><font color="#0000FF">then</font></b> u<font color="#990000">=</font><font color="#FF0000">{}</font><font color="#990000">;</font> <b><font color="#0000FF">for</font></b> _<font color="#990000">,</font>v <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>t<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> u<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">+</font>#u<font color="#990000">]=</font><b><font color="#000000">tostring</font></b><font color="#990000">(</font>v<font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
  <b><font color="#0000FF">else</font></b> ks<font color="#990000">=</font><font color="#FF0000">{}</font><font color="#990000">;</font> <b><font color="#0000FF">for</font></b> k<font color="#990000">,</font>_ <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>t<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> <b><font color="#0000FF">if</font></b> <b><font color="#000000">k:sub</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font><font color="#993399">1</font><font color="#990000">)~=</font><font color="#FF0000">"_"</font> <b><font color="#0000FF">then</font></b> ks<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">+</font>#ks<font color="#990000">]=</font>k <b><font color="#0000FF">end</font></b> <b><font color="#0000FF">end</font></b>
       table<font color="#990000">.</font><b><font color="#000000">sort</font></b><font color="#990000">(</font>ks<font color="#990000">)</font>
       u<font color="#990000">=</font><font color="#FF0000">{}</font><font color="#990000">;</font> <b><font color="#0000FF">for</font></b> _<font color="#990000">,</font>k <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>ks<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> u<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">+</font>#u<font color="#990000">]=</font> k<font color="#990000">..</font><font color="#FF0000">"="</font><font color="#990000">..</font><b><font color="#000000">tostring</font></b><font color="#990000">(</font>t<font color="#990000">[</font>k<font color="#990000">])</font> <b><font color="#0000FF">end</font></b> <b><font color="#0000FF">end</font></b>
  pre <font color="#990000">=</font> <font color="#990000">(</font><b><font color="#000000">getmetatable</font></b><font color="#990000">(</font>t<font color="#990000">)</font> <b><font color="#0000FF">or</font></b> <font color="#FF0000">{}</font><font color="#990000">).</font>_name <b><font color="#0000FF">or</font></b> <font color="#FF0000">""</font>
  <b><font color="#0000FF">return</font></b> pre<font color="#990000">..</font> <font color="#FF0000">"("</font><font color="#990000">..</font>table<font color="#990000">.</font><b><font color="#000000">concat</font></b><font color="#990000">(</font>u<font color="#990000">,</font><font color="#FF0000">", "</font><font color="#990000">)..</font><font color="#FF0000">")"</font> <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ## OO Stuff</font></i>

<i><font color="#9A1900">-- **klass(name:str):tbl**   </font></i>
<i><font color="#9A1900">-- Create a constructor `klass()` (and store a print `name`).</font></i>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">klass</font></b><font color="#990000">(</font>name<font color="#990000">,</font>   k<font color="#990000">)</font> 
  k<font color="#990000">=</font><font color="#FF0000">{}</font><font color="#990000">;</font> k<font color="#990000">.</font>_name<font color="#990000">=</font>name
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">setmetatable</font></b><font color="#990000">(</font>k<font color="#990000">,</font><font color="#FF0000">{</font>__call<font color="#990000">=</font><b><font color="#0000FF">function</font></b><font color="#990000">(</font>k<font color="#990000">,...)</font> <b><font color="#0000FF">return</font></b> <b><font color="#000000">k:new</font></b><font color="#990000">(...)</font> <b><font color="#0000FF">end</font></b><font color="#FF0000">}</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
<i><font color="#9A1900">-- **isa(klass:tbl, ?new:tbl, ?also:tbl):tbl**    </font></i>
<i><font color="#9A1900">-- Delegate calls to `new` to `klass`. If `also` exists, add those slots.</font></i>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>self<font color="#990000">,</font>    new<font color="#990000">,</font>also<font color="#990000">,</font> super<font color="#990000">)</font>
  new<font color="#990000">,</font> also <font color="#990000">=</font> new <b><font color="#0000FF">or</font></b> <font color="#FF0000">{}</font><font color="#990000">,</font> also <b><font color="#0000FF">or</font></b> <font color="#FF0000">{}</font>
  super <font color="#990000">=</font> <b><font color="#000000">getmetatable</font></b><font color="#990000">(</font>new<font color="#990000">)</font>
  <b><font color="#0000FF">if</font></b> super <b><font color="#0000FF">then</font></b> <b><font color="#000000">setmetatable</font></b><font color="#990000">(</font>self<font color="#990000">,</font> super<font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
  self<font color="#990000">.</font>__index<font color="#990000">,</font> self<font color="#990000">.</font>__tostring <font color="#990000">=</font> self<font color="#990000">,</font>show
  <b><font color="#0000FF">for</font></b> k<font color="#990000">,</font>v <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>also<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> new<font color="#990000">[</font>k<font color="#990000">]=</font>v <b><font color="#0000FF">end</font></b>
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">setmetatable</font></b><font color="#990000">(</font>new<font color="#990000">,</font> self<font color="#990000">)</font> <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ## obj()</font></i>

<i><font color="#9A1900">-- Base class.</font></i>
<b><font color="#0000FF">local</font></b> obj<font color="#990000">=</font>klass<font color="#FF0000">"obj"</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">obj:new</font></b><font color="#990000">()</font> <b><font color="#0000FF">return</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>obj<font color="#990000">)</font> <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- **some:new(?max=256):some**   </font></i>
<i><font color="#9A1900">-- Reservoir sampler (of upper size of `max`).</font></i>
<i><font color="#9A1900">-- If we fill up, delete anything at random.</font></i>
<i><font color="#9A1900">-- If we ask for `all` those values, then ensure them come back sorted.</font></i>
<b><font color="#0000FF">local</font></b> some<font color="#990000">=</font>klass<font color="#FF0000">"some"</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">some:new</font></b><font color="#990000">(</font>max<font color="#990000">)</font> 
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>self<font color="#990000">,</font><b><font color="#000000">obj:new</font></b><font color="#990000">(),</font><font color="#FF0000">{</font>max<font color="#990000">=</font>max <b><font color="#0000FF">or</font></b> <font color="#993399">256</font><font color="#990000">,</font>bad<font color="#990000">=</font><b><font color="#0000FF">false</font></b><font color="#990000">,</font>has<font color="#990000">=</font><font color="#FF0000">{}}</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">some:add</font></b><font color="#990000">(</font>x<font color="#990000">)</font>
  r <font color="#990000">=</font> math<font color="#990000">.</font>random
  <b><font color="#0000FF">if</font></b> #self<font color="#990000">.</font>has <font color="#990000">&lt;</font> self<font color="#990000">.</font>max <b><font color="#0000FF">then</font></b> pos <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">+</font>#self<font color="#990000">.</font>has 
  <b><font color="#0000FF">elseif</font></b> <b><font color="#000000">r</font></b><font color="#990000">()</font> <font color="#990000">&lt;</font> self<font color="#990000">.</font>max<font color="#990000">/</font>self<font color="#990000">.</font>n <b><font color="#0000FF">then</font></b> pos <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">+(</font><b><font color="#000000">r</font></b><font color="#990000">()*</font>#self<font color="#990000">.</font>has<font color="#990000">)//</font><font color="#993399">1</font> <b><font color="#0000FF">end</font></b> 
  <b><font color="#0000FF">if</font></b> pos <b><font color="#0000FF">then</font></b> self<font color="#990000">.</font>bad<font color="#990000">=</font><b><font color="#0000FF">true</font></b><font color="#990000">;</font> self<font color="#990000">.</font>has<font color="#990000">[</font>pos<font color="#990000">]=</font>x <b><font color="#0000FF">end</font></b> <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">some:all</font></b><font color="#990000">()</font>  
  <b><font color="#0000FF">if</font></b> self<font color="#990000">.</font>bad <b><font color="#0000FF">then</font></b> table<font color="#990000">.</font><b><font color="#000000">sort</font></b><font color="#990000">(</font>self<font color="#990000">.</font>has<font color="#990000">)</font> <b><font color="#0000FF">end</font></b><font color="#990000">;</font> self<font color="#990000">.</font>bad<font color="#990000">=</font><b><font color="#0000FF">false</font></b><font color="#990000">;</font> <b><font color="#0000FF">return</font></b> self<font color="#990000">.</font>has <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ## col():col</font></i>

<i><font color="#9A1900">-- Abstract class for columns. Allows one or more items to be added via `add` or `adds`.</font></i>
<b><font color="#0000FF">local</font></b> col<font color="#990000">=</font>klass<font color="#FF0000">"col"</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">col:new</font></b><font color="#990000">(</font>c<font color="#990000">,</font>s<font color="#990000">)</font> 
  s <font color="#990000">=</font> s <b><font color="#0000FF">or</font></b> <font color="#FF0000">""</font> 
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>self<font color="#990000">,</font> <b><font color="#000000">obj:new</font></b><font color="#990000">(),</font><font color="#FF0000">{</font>at<font color="#990000">=</font>c <b><font color="#0000FF">or</font></b> <font color="#993399">1</font><font color="#990000">,</font> name<font color="#990000">=</font>s<font color="#990000">,</font> n<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font>
                              w<font color="#990000">=</font>s<font color="#990000">:</font>find<font color="#FF0000">"+"</font> <b><font color="#0000FF">and</font></b> <font color="#993399">1</font> <b><font color="#0000FF">or</font></b> <font color="#990000">(</font>s<font color="#990000">:</font>find<font color="#FF0000">"-"</font> <b><font color="#0000FF">and</font></b> <font color="#990000">-</font><font color="#993399">1</font> <b><font color="#0000FF">or</font></b> <font color="#993399">0</font><font color="#990000">)</font><font color="#FF0000">}</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b> 
<b><font color="#0000FF">function</font></b> <b><font color="#000000">col:adds</font></b><font color="#990000">(</font>t<font color="#990000">)</font> 
  <b><font color="#0000FF">for</font></b> _<font color="#990000">,</font>x <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>t<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> <b><font color="#000000">self:add</font></b><font color="#990000">(</font>x<font color="#990000">)</font> <b><font color="#0000FF">end</font></b><font color="#990000">;</font> <b><font color="#0000FF">return</font></b> self <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">col:add</font></b><font color="#990000">(</font>x<font color="#990000">)</font> 
  <b><font color="#0000FF">if</font></b> x<font color="#990000">~=</font><font color="#FF0000">"?"</font> <b><font color="#0000FF">then</font></b> self<font color="#990000">.</font>n<font color="#990000">=</font><font color="#993399">1</font><font color="#990000">+</font>self<font color="#990000">.</font>n<font color="#990000">;</font> <b><font color="#000000">self:add1</font></b><font color="#990000">(</font>x<font color="#990000">)</font> <b><font color="#0000FF">end</font></b><font color="#990000">;</font> <b><font color="#0000FF">return</font></b> self <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ## num(?n:int, ?s:str):num</font></i>

<i><font color="#9A1900">-- Counter for numbers at column `n`, named `s`.    </font></i>
<i><font color="#9A1900">-- **:add(x)** updates the symbol counts.   </font></i>
<i><font color="#9A1900">-- **:mid()** returns central tendency.     </font></i>
<i><font color="#9A1900">-- **:var()** returns standard deviation.</font></i>
<b><font color="#0000FF">local</font></b> num<font color="#990000">=</font>klass<font color="#FF0000">"num"</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">num:new</font></b><font color="#990000">(</font>n<font color="#990000">,</font>s<font color="#990000">)</font> 
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>self<font color="#990000">,</font> <b><font color="#000000">col:new</font></b><font color="#990000">(</font>n<font color="#990000">,</font>s<font color="#990000">),</font>
             <font color="#FF0000">{</font>some<font color="#990000">=</font><b><font color="#000000">some:new</font></b><font color="#990000">(),</font> mu<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font>m2<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font>sd<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font>lo<font color="#990000">=</font><font color="#993399">1E32</font><font color="#990000">,</font>hi<font color="#990000">=-</font><font color="#993399">1E32</font><font color="#FF0000">}</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">num:mid</font></b><font color="#990000">()</font> 
  <b><font color="#0000FF">return</font></b> self<font color="#990000">.</font>mu <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">num:var</font></b><font color="#990000">()</font> 
  <b><font color="#0000FF">return</font></b> self<font color="#990000">.</font>sd <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">num:add1</font></b><font color="#990000">(</font>x<font color="#990000">,</font>    d<font color="#990000">)</font>
  self<font color="#990000">.</font><b><font color="#000000">some:add</font></b><font color="#990000">(</font>x<font color="#990000">)</font>
  d       <font color="#990000">=</font> x <font color="#990000">-</font> self<font color="#990000">.</font>mu
  self<font color="#990000">.</font>mu <font color="#990000">=</font> self<font color="#990000">.</font>mu <font color="#990000">+</font> d<font color="#990000">/</font>self<font color="#990000">.</font>n
  self<font color="#990000">.</font>m2 <font color="#990000">=</font> self<font color="#990000">.</font>m2 <font color="#990000">+</font> d<font color="#990000">*(</font>x <font color="#990000">-</font> self<font color="#990000">.</font>mu<font color="#990000">)</font>
  self<font color="#990000">.</font>sd <font color="#990000">=</font> <font color="#990000">(</font>self<font color="#990000">.</font>m2<font color="#990000">&lt;</font><font color="#993399">0</font> <b><font color="#0000FF">or</font></b> self<font color="#990000">.</font>n<font color="#990000">&lt;</font><font color="#993399">2</font><font color="#990000">)</font> <b><font color="#0000FF">and</font></b> <font color="#993399">0</font> <b><font color="#0000FF">or</font></b> <font color="#990000">(</font>self<font color="#990000">.</font>m2<font color="#990000">/(</font>self<font color="#990000">.</font>n<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">))^</font><font color="#993399">0.5</font>
  <b><font color="#0000FF">if</font></b> x <font color="#990000">&lt;</font> self<font color="#990000">.</font>lo <b><font color="#0000FF">then</font></b> self<font color="#990000">.</font>lo <font color="#990000">=</font> x <b><font color="#0000FF">end</font></b>
  <b><font color="#0000FF">if</font></b> x <font color="#990000">&gt;</font> self<font color="#990000">.</font>hi <b><font color="#0000FF">then</font></b> self<font color="#990000">.</font>hi <font color="#990000">=</font> x <b><font color="#0000FF">end</font></b> <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ## sym(?n:int, ?s:str):sym</font></i>

<i><font color="#9A1900">-- Counter for symbols at column `n`, named `s`.   </font></i>
<i><font color="#9A1900">-- **:add(x)** updates the symbol counts.   </font></i>
<i><font color="#9A1900">-- **:mid()** returns central tendency.     </font></i>
<i><font color="#9A1900">-- **:var()** returns entropy.</font></i>
<b><font color="#0000FF">local</font></b> sym<font color="#990000">=</font>klass<font color="#FF0000">"sym"</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">sym:new</font></b><font color="#990000">(</font>n<font color="#990000">,</font>s<font color="#990000">)</font> 
  <b><font color="#0000FF">return</font></b> <b><font color="#000000">isa</font></b><font color="#990000">(</font>self<font color="#990000">,</font><b><font color="#000000">col:new</font></b><font color="#990000">(</font>n<font color="#990000">,</font>s<font color="#990000">),</font><font color="#FF0000">{</font>most<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font>mode<font color="#990000">=</font><b><font color="#0000FF">nil</font></b><font color="#990000">,</font>has<font color="#990000">=</font><font color="#FF0000">{}}</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b> 
<b><font color="#0000FF">function</font></b> <b><font color="#000000">sym:mid</font></b><font color="#990000">()</font> 
  <b><font color="#0000FF">return</font></b> self<font color="#990000">.</font>mode <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">sym:var</font></b><font color="#990000">(</font>  e<font color="#990000">)</font> 
  e<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> <b><font color="#0000FF">for</font></b> _<font color="#990000">,</font>v <b><font color="#0000FF">in</font></b> <b><font color="#000000">pairs</font></b><font color="#990000">(</font>self<font color="#990000">.</font>has<font color="#990000">)</font> <b><font color="#0000FF">do</font></b> e<font color="#990000">=</font>e <font color="#990000">-</font> v<font color="#990000">/</font>self<font color="#990000">.</font>n <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>v<font color="#990000">/</font>self<font color="#990000">.</font>n<font color="#990000">,</font><font color="#993399">2</font><font color="#990000">)</font> <b><font color="#0000FF">end</font></b>
  <b><font color="#0000FF">return</font></b> e <b><font color="#0000FF">end</font></b>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">sym:add1</font></b><font color="#990000">(</font>x<font color="#990000">,</font>    d<font color="#990000">)</font>
  self<font color="#990000">.</font>has<font color="#990000">[</font>x<font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">1</font> <font color="#990000">+</font> <font color="#990000">(</font>self<font color="#990000">.</font>has<font color="#990000">[</font>x<font color="#990000">]</font> <b><font color="#0000FF">or</font></b> <font color="#993399">0</font><font color="#990000">)</font>
  <b><font color="#0000FF">if</font></b> self<font color="#990000">.</font>has<font color="#990000">[</font>x<font color="#990000">]</font> <font color="#990000">&gt;</font> self<font color="#990000">.</font> most <b><font color="#0000FF">then</font></b> self<font color="#990000">.</font>most<font color="#990000">,</font>self<font color="#990000">.</font>mode<font color="#990000">=</font>self<font color="#990000">.</font>has<font color="#990000">[</font>x<font color="#990000">],</font> x <b><font color="#0000FF">end</font></b> <b><font color="#0000FF">end</font></b>

<i><font color="#9A1900">-- ---------------------------------------</font></i>
s<font color="#990000">=</font><b><font color="#000000">sym</font></b><font color="#990000">():</font>adds<font color="#FF0000">{</font><font color="#FF0000">"a"</font><font color="#990000">,</font><font color="#FF0000">"a"</font><font color="#990000">,</font><font color="#FF0000">"a"</font><font color="#990000">,</font><font color="#FF0000">"b"</font><font color="#990000">,</font><font color="#FF0000">"b"</font><font color="#FF0000">}</font>
c<font color="#990000">=</font><b><font color="#000000">num</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font><font color="#FF0000">"asdas-"</font><font color="#990000">):</font>adds<font color="#FF0000">{</font><font color="#993399">22</font><font color="#990000">,</font><font color="#993399">32</font><font color="#990000">,</font><font color="#993399">41</font><font color="#990000">,</font><font color="#993399">100</font><font color="#990000">,</font><font color="#993399">1</font><font color="#FF0000">}</font>
<b><font color="#000000">print</font></b><font color="#990000">(</font>c<font color="#990000">)</font>
<b><font color="#000000">print</font></b><font color="#990000">(</font>s<font color="#990000">)</font>
<b><font color="#000000">print</font></b><font color="#990000">(</font>show<font color="#FF0000">{</font><font color="#993399">200</font><font color="#990000">,</font><font color="#993399">10</font><font color="#990000">,</font><font color="#993399">10000</font><font color="#FF0000">}</font><font color="#990000">)</font>
</tt></pre>
