<!DOCTYPE html>

<html>
<head>
  <title>test.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>test.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p><strong>showr(t:tbl) :str</strong><br>Return table as string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">(t,     u,mt,pre)</span></span>
  <span class="hljs-keyword">if</span>   #t&gt;<span class="hljs-number">0</span>
  <span class="hljs-keyword">then</span> u={}; <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]=<span class="hljs-built_in">tostring</span>(v) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">else</span> ks={}; <span class="hljs-keyword">for</span> k,_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> k:<span class="hljs-built_in">sub</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)~=<span class="hljs-string">&quot;_&quot;</span> <span class="hljs-keyword">then</span> ks[<span class="hljs-number">1</span>+#ks]=k <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
       <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(ks)
       u={}; <span class="hljs-keyword">for</span> _,k <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ks) <span class="hljs-keyword">do</span> u[<span class="hljs-number">1</span>+#u]= k..<span class="hljs-string">&quot;=&quot;</span>..<span class="hljs-built_in">tostring</span>(t[k]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
  pre = (<span class="hljs-built_in">getmetatable</span>(t) <span class="hljs-keyword">or</span> {})._name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-keyword">return</span> pre.. <span class="hljs-string">&quot;(&quot;</span>..<span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(u,<span class="hljs-string">&quot;, &quot;</span>)..<span class="hljs-string">&quot;)&quot;</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <h2 id="oo-stuff">OO Stuff</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p><strong>klass(name:str):tbl</strong><br>Create a constructor <code>klass()</code> (and store a print <code>name</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">klass</span><span class="hljs-params">(name,   k)</span></span> 
  k={}; k._name=name
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(k,{<span class="hljs-built_in">__call</span>=<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(k,...)</span></span> <span class="hljs-keyword">return</span> k:new(...) <span class="hljs-keyword">end</span>}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p><strong>isa(klass:tbl, ?new:tbl, ?also:tbl):tbl</strong><br>Delegate calls to <code>new</code> to <code>klass</code>. If <code>also</code> exists, add those slots.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isa</span><span class="hljs-params">(self,    new,also, super)</span></span>
  new, also = new <span class="hljs-keyword">or</span> {}, also <span class="hljs-keyword">or</span> {}
  super = <span class="hljs-built_in">getmetatable</span>(new)
  <span class="hljs-keyword">if</span> super <span class="hljs-keyword">then</span> <span class="hljs-built_in">setmetatable</span>(<span class="hljs-built_in">self</span>, super) <span class="hljs-keyword">end</span>
  <span class="hljs-built_in">self</span>.<span class="hljs-built_in">__index</span>, <span class="hljs-built_in">self</span>.<span class="hljs-built_in">__tostring</span> = <span class="hljs-built_in">self</span>,show
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(also) <span class="hljs-keyword">do</span> new[k]=v <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">setmetatable</span>(new, <span class="hljs-built_in">self</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <h2 id="obj">obj()</h2>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Base class.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> obj=klass<span class="hljs-string">&quot;obj&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">obj:new</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> isa(obj) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p><strong>some:new(?max=256):some</strong><br>Reservoir sampler (of upper size of <code>max</code>).
If we fill up, delete anything at random.
If we ask for <code>all</code> those values, then ensure them come back sorted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> some=klass<span class="hljs-string">&quot;some&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">some:new</span><span class="hljs-params">(max)</span></span> 
  <span class="hljs-keyword">return</span> isa(<span class="hljs-built_in">self</span>,obj:new(),{<span class="hljs-built_in">max</span>=<span class="hljs-built_in">max</span> <span class="hljs-keyword">or</span> <span class="hljs-number">256</span>,bad=<span class="hljs-literal">false</span>,has={}}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">some:add</span><span class="hljs-params">(x)</span></span>
  r = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>
  <span class="hljs-keyword">if</span> #<span class="hljs-built_in">self</span>.has &lt; <span class="hljs-built_in">self</span>.<span class="hljs-built_in">max</span> <span class="hljs-keyword">then</span> pos = <span class="hljs-number">1</span>+#<span class="hljs-built_in">self</span>.has 
  <span class="hljs-keyword">elseif</span> r() &lt; <span class="hljs-built_in">self</span>.<span class="hljs-built_in">max</span>/<span class="hljs-built_in">self</span>.n <span class="hljs-keyword">then</span> pos = <span class="hljs-number">1</span>+(r()*#<span class="hljs-built_in">self</span>.has)//<span class="hljs-number">1</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.bad=<span class="hljs-literal">true</span>; <span class="hljs-built_in">self</span>.has[pos]=x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">some:all</span><span class="hljs-params">()</span></span>  
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.bad <span class="hljs-keyword">then</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(<span class="hljs-built_in">self</span>.has) <span class="hljs-keyword">end</span>; <span class="hljs-built_in">self</span>.bad=<span class="hljs-literal">false</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.has <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <h2 id="colcol">col():col</h2>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Abstract class for columns. Allows one or more items to be added via <code>add</code> or <code>adds</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> col=klass<span class="hljs-string">&quot;col&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">col:new</span><span class="hljs-params">(c,s)</span></span> 
  s = s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span> 
  <span class="hljs-keyword">return</span> isa(<span class="hljs-built_in">self</span>, obj:new(),{at=c <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>, name=s, n=<span class="hljs-number">0</span>,
                              w=s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;+&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> (s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)}) <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">col:adds</span><span class="hljs-params">(t)</span></span> 
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> <span class="hljs-built_in">self</span>:add(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">col:add</span><span class="hljs-params">(x)</span></span> 
  <span class="hljs-keyword">if</span> x~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.n=<span class="hljs-number">1</span>+<span class="hljs-built_in">self</span>.n; <span class="hljs-built_in">self</span>:add1(x) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <h2 id="numnint-sstrnum">num(?n:int, ?s:str):num</h2>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Counter for numbers at column <code>n</code>, named <code>s</code>.<br><strong>:add(x)</strong> updates the symbol counts.<br><strong>:mid()</strong> returns central tendency.<br><strong>:var()</strong> returns standard deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> num=klass<span class="hljs-string">&quot;num&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num:new</span><span class="hljs-params">(n,s)</span></span> 
  <span class="hljs-keyword">return</span> isa(<span class="hljs-built_in">self</span>, col:new(n,s),
             {some=some:new(), mu=<span class="hljs-number">0</span>,m2=<span class="hljs-number">0</span>,sd=<span class="hljs-number">0</span>,lo=<span class="hljs-number">1E32</span>,hi=<span class="hljs-number">-1E32</span>}) <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num:mid</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mu <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num:var</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.sd <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">num:add1</span><span class="hljs-params">(x,    d)</span></span>
  <span class="hljs-built_in">self</span>.some:add(x)
  d       = x - <span class="hljs-built_in">self</span>.mu
  <span class="hljs-built_in">self</span>.mu = <span class="hljs-built_in">self</span>.mu + d/<span class="hljs-built_in">self</span>.n
  <span class="hljs-built_in">self</span>.m2 = <span class="hljs-built_in">self</span>.m2 + d*(x - <span class="hljs-built_in">self</span>.mu)
  <span class="hljs-built_in">self</span>.sd = (<span class="hljs-built_in">self</span>.m2&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.n&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (<span class="hljs-built_in">self</span>.m2/(<span class="hljs-built_in">self</span>.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span>
  <span class="hljs-keyword">if</span> x &lt; <span class="hljs-built_in">self</span>.lo <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.lo = x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">if</span> x &gt; <span class="hljs-built_in">self</span>.hi <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.hi = x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <h2 id="symnint-sstrsym">sym(?n:int, ?s:str):sym</h2>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Counter for symbols at column <code>n</code>, named <code>s</code>.<br><strong>:add(x)</strong> updates the symbol counts.<br><strong>:mid()</strong> returns central tendency.<br><strong>:var()</strong> returns entropy.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> sym=klass<span class="hljs-string">&quot;sym&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym:new</span><span class="hljs-params">(n,s)</span></span> 
  <span class="hljs-keyword">return</span> isa(<span class="hljs-built_in">self</span>,col:new(n,s),{most=<span class="hljs-number">0</span>,mode=<span class="hljs-literal">nil</span>,has={}}) <span class="hljs-keyword">end</span> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym:mid</span><span class="hljs-params">()</span></span> 
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mode <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym:var</span><span class="hljs-params">(  e)</span></span> 
  e=<span class="hljs-number">0</span>; <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.has) <span class="hljs-keyword">do</span> e=e - v/<span class="hljs-built_in">self</span>.n * <span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(v/<span class="hljs-built_in">self</span>.n,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sym:add1</span><span class="hljs-params">(x,    d)</span></span>
  <span class="hljs-built_in">self</span>.has[x] = <span class="hljs-number">1</span> + (<span class="hljs-built_in">self</span>.has[x] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.has[x] &gt; <span class="hljs-built_in">self</span>. most <span class="hljs-keyword">then</span> <span class="hljs-built_in">self</span>.most,<span class="hljs-built_in">self</span>.mode=<span class="hljs-built_in">self</span>.has[x], x <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>s=sym():adds{<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>}
c=num(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;asdas-&quot;</span>):adds{<span class="hljs-number">22</span>,<span class="hljs-number">32</span>,<span class="hljs-number">41</span>,<span class="hljs-number">100</span>,<span class="hljs-number">1</span>}
<span class="hljs-built_in">print</span>(c)
<span class="hljs-built_in">print</span>(s)
<span class="hljs-built_in">print</span>(show{<span class="hljs-number">200</span>,<span class="hljs-number">10</span>,<span class="hljs-number">10000</span>})</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
